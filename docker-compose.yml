version: '3'

services:
  app:
    image: ghcr.io/pythoninthegrass/docker_graphical:latest
    container_name: docker_graphical
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - 22:22/tcp
      - 3389:3389/tcp
    init: true
    shm_size: 2g
    # GPU PASSTHROUGH
    deploy:
      resources:
        reservations:
          # Enable support for NVIDIA GPUs.
          # Ref: https://docs.docker.com/compose/gpu-support/#enabling-gpu-access-to-service-containers
          devices:
            - capabilities: [gpu]
              device_ids: ["${NVIDIA_VISIBLE_DEVICES}"]
    network_mode: host
    hostname: ${NAME:-localhost}
    extra_hosts:
      - "${NAME:-localhost}:127.0.0.1"
    environment:
      - TZ=${TZ:-Etc/UTC}
      - USER_LOCALES=${USER_LOCALES:-en_US.UTF-8 UTF-8}
      - DISPLAY=${DISPLAY:-:55}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - UMASK=${UMASK:-000}
      - USER_PASSWORD=${USER_PASSWORD?Variable USER_PASSWORD not set}
      - ENABLE_STEAM=${ENABLE_STEAM:-true}
      - STEAM_ARGS=${STEAM_ARGS:-"-silent"}
      - ENABLE_SUNSHINE=${ENABLE_SUNSHINE:-false}
      - SUNSHINE_USER=${SUNSHINE_USER:-admin}
      - SUNSHINE_PASS=${SUNSHINE_PASS:-admin}
      - ENABLE_EVDEV_INPUTS=${ENABLE_EVDEV_INPUTS:-true}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-all}
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_VERSION=${NVIDIA_DRIVER_VERSION}
    devices:
      - /dev/fuse
      - /dev/uinput
    device_cgroup_rules:
      - 'c 13:* rmw'
    # TODO: fails to connect to xrdp if volumes are mounted
    volumes:
      - ./data/games:/mnt/games:rw
      # - ./data/ssh:/etc/dropbear
      # - ./data/xrdp:/etc/xrdp

networks:
  default:
    driver: bridge
